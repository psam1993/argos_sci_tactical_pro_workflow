<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa T√°tico | ARGOS SCI</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="brand"><i data-lucide="shield"></i> <span>ARGOS SCI</span></div>
        <nav class="nav">
            <a href="index.html"><i data-lucide="layout-dashboard"></i> <span>Dashboard</span></a>
            <a href="incidente.html"><i data-lucide="file-text"></i> <span>Configura√ß√£o SCI</span></a>
            <a href="mapa.html"><i data-lucide="map"></i> <span>Mapa T√°tico</span></a>
            <a href="workflow.html"><i data-lucide="git-merge"></i> <span>Workflow PO</span></a>
            <a href="painel_papel.html"><i data-lucide="user-cog"></i> <span>Painel por Papel</span></a>
            <a href="planejamento.html"><i data-lucide="clipboard-list"></i> <span>Planejamento</span></a>
            <a href="operacoes.html"><i data-lucide="swords"></i> <span>Opera√ß√µes</span></a>
            <a href="logistica.html"><i data-lucide="truck"></i> <span>Log√≠stica</span></a>
            <a href="admfin.html"><i data-lucide="wallet"></i> <span>Adm/Fin</span></a>
            <a href="seguranca.html"><i data-lucide="hard-hat"></i> <span>Seguran√ßa</span></a>
            <a href="informacao_publica.html"><i data-lucide="megaphone"></i> <span>Info P√∫blica</span></a>
            <a href="ligacoes.html"><i data-lucide="handshake"></i> <span>Liga√ß√µes</span></a>
            <a href="equipes.html"><i data-lucide="users"></i> <span>Recursos</span></a>
            <a href="relatorios.html"><i data-lucide="printer"></i> <span>Relat√≥rios / PAI</span></a>
        </nav>
        <div style="background: #ffffff05; padding: 15px; border-radius: 10px; margin-top: 20px;">
            <div class="badge badge-ok" style="margin-bottom: 5px;">Sistema Online</div>
            <div style="font-size: 11px; color: var(--muted);">Cuiab√°/MT - Mapa T√°tico</div>
        </div>
    </aside>
    <div class="main">
        <header class="topbar">
            <div style="display:flex; gap: 20px; align-items:center;">
                <span class="muted" style="font-size: 13px;">INCIDENTE ATIVO:</span> 
                <strong style="letter-spacing: 0.5px;">#SCI-2026-004</strong>
            </div>
            <div style="display:flex; gap: 20px; align-items:center;">
                <div style="text-align: right; line-height: 1.2;">
                    <div style="font-size: 12px; font-weight: 700; color: var(--warn);">PO-02 EM CURSO</div>
                    <div class="muted" style="font-size: 10px;">FECHAMENTO: 14 JAN 06:00</div>
                </div>
                <div style="width:38px; height:38px; background:var(--brand); border-radius:10px; display:grid; place-items:center; font-weight:bold; color:#000; cursor:pointer;">RS</div>
            </div>
        </header>
        <section class="content">
<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2><i data-lucide="map-pin"></i> Consci√™ncia Situacional - Mapa T√°tico</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <select id="map_layer" style="width:auto; margin:0; padding:8px;" onchange="changeLayer()">
                <option value="osm">Mapa Base</option>
                <option value="satellite" selected>Vis√£o Sat√©lite</option>
                <option value="topo">Topografia</option>
            </select>
            <button class="btn btn-secondary" id="btn_draw_line" onclick="toggleDrawMode('line')" style="display:none;"><i data-lucide="pen-tool"></i> Aceiro</button>
            <button class="btn btn-secondary" id="btn_draw_poly" onclick="toggleDrawMode('polygon')" style="display:none;"><i data-lucide="square"></i> Zona</button>
            <button class="btn btn-secondary" onclick="editWorkArea()"><i data-lucide="edit"></i> Editar √Årea</button>
            <button class="btn btn-primary" id="btn_refresh_teams" onclick="loadTeamsFromOps()"><i data-lucide="rotate-cw"></i> Sincronizar Equipes</button>
            <button class="btn btn-secondary" onclick="addNewTeamToMap()"><i data-lucide="plus"></i> Adicionar Equipe em Campo</button>
        </div>
    </div>

    <div id="map" style="height:500px; border-radius:10px; overflow:hidden;"></div>

    <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px; background: #00000020; padding:15px; border-radius:10px;">
        <div style="display:flex; align-items:center; gap:8px;">
            <span style="width:15px; height:15px; background:#ef4444; border-radius:50%;"></span> 
            <span style="font-size:13px; font-weight:600;">√Årea de Trabalho</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <span style="width:15px; height:15px; background:#3b82f6; border-radius:50%;"></span> 
            <span style="font-size:13px; font-weight:600;">Equipe de Campo</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <span style="width:15px; height:3px; background:#22c55e; border-radius:1px;"></span> 
            <span style="font-size:13px; font-weight:600;">Linha de Defesa</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <span style="width:15px; height:15px; background:#0ea5e9; border-radius:3px;"></span> 
            <span style="font-size:13px; font-weight:600;">PC (Azul)</span>
        </div>
    </div>

    <div style="margin-top:20px; padding:15px; background:#ffffff02; border-radius:10px;">
        <h3 style="margin-top:0;">Editar Posi√ß√µes de Equipes</h3>
        <div id="teams_control_panel" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:16px;"></div>
        <h3>Equipes Posicionadas</h3>
        <div id="teams_list" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;"></div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
let mapInstance, teamMarkers = {}, drawMode = null, isDrawing = false, drawnItems = new L.FeatureGroup(), layers = {}, pcMarker, workAreaCircle;

function initMap(){
  mapInstance = L.map('map').setView([-15.603, -56.096], 14);
  
  // M√∫ltiplas camadas de tiles
  layers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenStreetMap'});
  layers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: '¬© Esri'});
  layers.topo = L.tileLayer('https://tile.opentopomap.org/{z}/{x}/{y}.png', {attribution: '¬© OpenTopoMap'});
  
  layers.satellite.addTo(mapInstance);
  mapInstance.addLayer(drawnItems);

  // Carregar dados de √°rea de trabalho salvos
  const mapData = Store.get('map_drawings', {});
  const workAreaData = mapData.work_area || {lat: -15.604, lng: -56.095, radius: 400};
  
  // √Årea de Trabalho (VERMELHA) - agora edit√°vel
  workAreaCircle = L.circle([workAreaData.lat, workAreaData.lng], { 
    color:'#ef4444', 
    fillColor:'#ef4444', 
    fillOpacity:0.2, 
    radius: workAreaData.radius,
    weight: 2
  }).addTo(mapInstance);
  
  updateWorkAreaPopup();

  // Posto de Comando (AZUL)
  const pcIcon = L.divIcon({
    html: '<div style="background:#0ea5e9; width:18px; height:18px; border:3px solid #fff; border-radius:4px; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff; font-size:10px;">PC</div>',
    className: '',
    iconSize: [24, 24]
  });
  
  pcMarker = L.marker([-15.610, -56.090], {icon: pcIcon, draggable: true}).addTo(mapInstance);
  pcMarker.bindPopup(`<b>POSTO DE COMANDO (PC)</b><br><small>Lat: -15.6100, Lng: -56.0900</small><br><button class="btn btn-secondary" style="font-size:11px; margin-top:8px; width:100%;" onclick="editPCPosition()">Editar Posi√ß√£o</button>`);
  
  pcMarker.on('dragend', () => { 
    const pos = pcMarker.getLatLng();
    const mapData = Store.get('map_drawings', {});
    mapData.pc_position = {lat: pos.lat, lng: pos.lng};
    Store.set('map_drawings', mapData);
    updatePCPopup();
  });

  loadTeamsFromOps();
  loadMapDrawings();
}

function updatePCPopup(){
  if(pcMarker) {
    const pos = pcMarker.getLatLng();
    pcMarker.setPopupContent(`<b>POSTO DE COMANDO (PC)</b><br><small>Lat: ${pos.lat.toFixed(4)}, Lng: ${pos.lng.toFixed(4)}</small><br><button class="btn btn-secondary" style="font-size:11px; margin-top:8px; width:100%;" onclick="editPCPosition()">Editar Posi√ß√£o</button>`);
  }
}

function editPCPosition(){
  const pos = pcMarker.getLatLng();
  const newLat = prompt('Latitude do PC:', pos.lat.toFixed(6));
  if(newLat === null) return;
  const newLng = prompt('Longitude do PC:', pos.lng.toFixed(6));
  if(newLng === null) return;
  
  try {
    const lat = parseFloat(newLat);
    const lng = parseFloat(newLng);
    if(isNaN(lat) || isNaN(lng)) throw new Error('Valores inv√°lidos');
    pcMarker.setLatLng([lat, lng]);
    mapInstance.panTo([lat, lng]);
    
    const mapData = Store.get('map_drawings', {});
    mapData.pc_position = {lat, lng};
    Store.set('map_drawings', mapData);
    updatePCPopup();
    ARGOS.toast('Posi√ß√£o do PC atualizada.');
  } catch(e) {
    ARGOS.toast('Erro ao atualizar PC: ' + e.message);
  }
}

function changeLayer(){
  const layer = document.getElementById('map_layer').value;
  Object.keys(layers).forEach(l => mapInstance.removeLayer(layers[l]));
  mapInstance.addLayer(layers[layer]);
}

function loadTeamsFromOps(){
  const opData = Store.get('operations_form', null);
  const teamsStr = opData?.efetivo_empregado?.guarni√ß√µes_total || '';
  const teamIds = teamsStr.split(',').map(t => t.trim()).filter(t => t);
  
  // Limpar marcadores antigos
  Object.keys(teamMarkers).forEach(id => mapInstance.removeLayer(teamMarkers[id]));
  teamMarkers = {};
  
  // Cores padr√£o para equipes
  const colors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#06B6D4'];
  let colorIdx = 0;
  
  // Carregar posi√ß√µes salvas
  const mapData = Store.get('map_drawings', {});
  const savedPositions = mapData.team_positions || {};
  
  teamIds.forEach((teamId, idx) => {
    const color = colors[colorIdx++ % colors.length];
    
    // Tentar carregar posi√ß√£o salva, sen√£o usar aleat√≥ria
    let lat, lng;
    if(savedPositions[teamId]) {
      lat = savedPositions[teamId].lat;
      lng = savedPositions[teamId].lng;
    } else {
      lat = -15.604 + (Math.random() - 0.5) * 0.008;
      lng = -56.095 + (Math.random() - 0.5) * 0.008;
    }
    
    const icon = L.divIcon({
      html: `<div style="background:${color}; width:20px; height:20px; border-radius:50%; border:3px solid #fff; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:11px; color:#fff; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.3);">${teamId.slice(-2)}</div>`,
      className: '',
      iconSize: [26, 26]
    });
    
    const marker = L.marker([lat, lng], {icon, draggable: true}).addTo(mapInstance);
    updateTeamPopup(marker, teamId, lat, lng);
    
    marker.on('dragend', () => { 
      const pos = marker.getLatLng();
      saveTeamPosition(teamId, pos);
      updateTeamPopup(marker, teamId, pos.lat, pos.lng);
    });
    
    teamMarkers[teamId] = {marker, color};
  });
  
  renderTeamsControlPanel(teamIds);
  renderTeamsList(teamIds);
  ARGOS.toast(`${teamIds.length} equipes carregadas do planejamento.`);
}

function updateTeamPopup(marker, teamId, lat, lng){
  marker.bindPopup(`
    <div>
      <b>${teamId}</b><br>
      <small>Lat: ${lat.toFixed(4)}<br>Lng: ${lng.toFixed(4)}</small><br>
      <button class="btn btn-secondary" style="font-size:11px; margin-top:8px; width:100%;" onclick="editTeamPosition('${teamId}')">Editar Coords</button>
    </div>
  `);
}

function editTeamPosition(teamId){
  const marker = teamMarkers[teamId]?.marker;
  if(!marker) return;
  
  const pos = marker.getLatLng();
  const newLat = prompt(`Latitude de ${teamId}:`, pos.lat.toFixed(6));
  if(newLat === null) return;
  
  const newLng = prompt(`Longitude de ${teamId}:`, pos.lng.toFixed(6));
  if(newLng === null) return;
  
  try {
    const lat = parseFloat(newLat);
    const lng = parseFloat(newLng);
    if(isNaN(lat) || isNaN(lng)) throw new Error('Valores inv√°lidos');
    
    marker.setLatLng([lat, lng]);
    saveTeamPosition(teamId, {lat, lng});
    updateTeamPopup(marker, teamId, lat, lng);
    ARGOS.toast(`Posi√ß√£o de ${teamId} atualizada.`);
  } catch(e) {
    ARGOS.toast('Erro: ' + e.message);
  }
}

function renderTeamsControlPanel(teamIds){
  const html = teamIds.map((tid) => `
    <div style="padding:12px; background:#ffffff05; border-radius:8px; border-left:3px solid ${teamMarkers[tid]?.color || '#3B82F6'};">
      <div style="font-weight:600; margin-bottom:8px;">${tid}</div>
      <button class="btn btn-secondary" onclick="editTeamPosition('${tid}')" style="font-size:11px; width:100%; margin-bottom:6px;">üìç Editar Coords</button>
      <button class="btn btn-secondary" onclick="panToTeam('${tid}')" style="font-size:11px; width:100%;">üéØ Localizar</button>
    </div>
  `).join('');
  
  document.getElementById('teams_control_panel').innerHTML = html || '<div class="muted">Nenhuma equipe. Sincronize com Opera√ß√µes.</div>';
}

function renderTeamsList(teamIds){
  const html = teamIds.map((tid) => {
    const marker = teamMarkers[tid]?.marker;
    const pos = marker ? marker.getLatLng() : {lat: 0, lng: 0};
    
    return `
      <div style="padding:12px; background:#ffffff05; border-radius:8px; border-left:3px solid ${teamMarkers[tid]?.color || '#3B82F6'};">
        <div style="font-weight:600;">${tid}</div>
        <div style="font-size:11px; color:var(--muted); margin-top:4px; font-family:monospace;">
          Lat: ${pos.lat.toFixed(4)}<br>Lng: ${pos.lng.toFixed(4)}
        </div>
        <div style="font-size:11px; color:var(--muted); margin-top:4px;">Ativa em campo</div>
      </div>
    `;
  }).join('');
  
  document.getElementById('teams_list').innerHTML = html || '<div class="muted">Nenhuma equipe posicionada. Sincronize com Opera√ß√µes.</div>';
}

function updateWorkAreaPopup(){
  if(workAreaCircle) {
    const pos = workAreaCircle.getLatLng();
    const radius = workAreaCircle.getRadius();
    workAreaCircle.setPopupContent(`
      <div>
        <b>√Årea de Trabalho</b><br>
        <small>Lat: ${pos.lat.toFixed(4)}, Lng: ${pos.lng.toFixed(4)}</small><br>
        <small>Raio: ${radius}m</small><br>
        <button class="btn btn-secondary" style="font-size:11px; margin-top:8px; width:100%; margin-bottom:4px;" onclick="editWorkArea()">‚úèÔ∏è Editar √Årea</button>
        <button class="btn btn-secondary" style="font-size:11px; width:100%;" onclick="changeWorkAreaType()">üîÑ Mudar Tipo</button>
      </div>
    `);
    workAreaCircle.bindPopup(`
      <div>
        <b>√Årea de Trabalho</b><br>
        <small>Lat: ${pos.lat.toFixed(4)}, Lng: ${pos.lng.toFixed(4)}</small><br>
        <small>Raio: ${radius}m</small><br>
        <button class="btn btn-secondary" style="font-size:11px; margin-top:8px; width:100%; margin-bottom:4px;" onclick="editWorkArea()">‚úèÔ∏è Editar √Årea</button>
        <button class="btn btn-secondary" style="font-size:11px; width:100%;" onclick="changeWorkAreaType()">üîÑ Mudar Tipo</button>
      </div>
    `);
  }
}

function editWorkArea(){
  // Modal para editar √°rea de trabalho
  const modal = document.createElement('div');
  modal.id = 'modal_edit_work_area';
  modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:10000;';
  
  const pos = workAreaCircle.getLatLng();
  const radius = workAreaCircle.getRadius();
  
  const content = document.createElement('div');
  content.style.cssText = 'background:#1a1a2e; border:1px solid var(--border); border-radius:12px; padding:24px; width:90%; max-width:500px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.5);';
  
  content.innerHTML = `
    <h3 style="margin-top:0; margin-bottom:20px;">Editar √Årea de Trabalho</h3>
    
    <div style="margin-bottom:16px;">
      <label style="display:block; margin-bottom:8px;"><strong>Latitude</strong></label>
      <input id="wa_lat" type="number" step="0.0001" value="${pos.lat.toFixed(6)}" style="padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--surface); width:100%; box-sizing:border-box;">
    </div>
    
    <div style="margin-bottom:16px;">
      <label style="display:block; margin-bottom:8px;"><strong>Longitude</strong></label>
      <input id="wa_lng" type="number" step="0.0001" value="${pos.lng.toFixed(6)}" style="padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--surface); width:100%; box-sizing:border-box;">
    </div>
    
    <div style="margin-bottom:16px;">
      <label style="display:block; margin-bottom:8px;"><strong>Raio (metros)</strong></label>
      <input id="wa_radius" type="number" min="50" step="50" value="${radius}" style="padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--surface); width:100%; box-sizing:border-box;">
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:8px;">
        <button class="btn btn-secondary" style="font-size:11px;" onclick="setWorkAreaRadius(300)">300m</button>
        <button class="btn btn-secondary" style="font-size:11px;" onclick="setWorkAreaRadius(500)">500m</button>
        <button class="btn btn-secondary" style="font-size:11px;" onclick="setWorkAreaRadius(1000)">1km</button>
      </div>
    </div>
    
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button class="btn btn-secondary" onclick="closeModalWorkArea()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveWorkAreaChanges()">Salvar</button>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
}

function setWorkAreaRadius(radius){
  document.getElementById('wa_radius').value = radius;
}

function closeModalWorkArea(){
  const modal = document.getElementById('modal_edit_work_area');
  if(modal) modal.remove();
}

function saveWorkAreaChanges(){
  const lat = parseFloat(document.getElementById('wa_lat').value);
  const lng = parseFloat(document.getElementById('wa_lng').value);
  const radius = parseFloat(document.getElementById('wa_radius').value);
  
  if(isNaN(lat) || isNaN(lng) || isNaN(radius)) {
    ARGOS.toast('Valores inv√°lidos.');
    return;
  }
  
  if(radius < 50) {
    ARGOS.toast('Raio m√≠nimo: 50m');
    return;
  }
  
  // Atualizar c√≠rculo
  workAreaCircle.setLatLng([lat, lng]);
  workAreaCircle.setRadius(radius);
  
  // Salvar dados
  const mapData = Store.get('map_drawings', {});
  mapData.work_area = {lat, lng, radius};
  Store.set('map_drawings', mapData);
  
  closeModalWorkArea();
  updateWorkAreaPopup();
  mapInstance.panTo([lat, lng]);
  ARGOS.toast(`√Årea atualizada: ${(radius/1000).toFixed(2)}km de raio.`);
}

function changeWorkAreaType(){
  // Modal para mudar tipo de delimita√ß√£o
  const modal = document.createElement('div');
  modal.id = 'modal_work_area_type';
  modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:10000;';
  
  const content = document.createElement('div');
  content.style.cssText = 'background:#1a1a2e; border:1px solid var(--border); border-radius:12px; padding:24px; width:90%; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.5);';
  
  content.innerHTML = `
    <h3 style="margin-top:0; margin-bottom:20px;">Tipo de Delimita√ß√£o</h3>
    <p style="color:var(--muted); margin-bottom:16px;">Escolha como delimitar a √°rea de trabalho:</p>
    
    <div style="display:flex; flex-direction:column; gap:10px;">
      <button class="btn btn-secondary" style="width:100%; justify-content:center;" onclick="closeModalWorkAreaType(); editWorkArea()">
        üîµ Raio Circular (Atual)
      </button>
      <button class="btn btn-secondary" style="width:100%; justify-content:center;" onclick="drawPolygonWorkArea()">
        üî∑ Pol√≠gono Personalizado
      </button>
      <button class="btn btn-secondary" style="width:100%; justify-content:center;" onclick="drawRectangleWorkArea()">
        üì¶ Ret√¢ngulo
      </button>
      <hr style="border:none; border-top:1px solid var(--border); margin:10px 0;">
      <button class="btn btn-secondary" onclick="closeModalWorkAreaType()">Cancelar</button>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
}

function closeModalWorkAreaType(){
  const modal = document.getElementById('modal_work_area_type');
  if(modal) modal.remove();
}

function drawPolygonWorkArea(){
  closeModalWorkAreaType();
  ARGOS.toast('Clique no mapa para desenhar o pol√≠gono. Duplo-clique para finalizar.');
  // Usar Leaflet Draw para pol√≠gonos
  toggleDrawMode('polygon');
}

function drawRectangleWorkArea(){
  closeModalWorkAreaType();
  ARGOS.toast('Implementa√ß√£o de ret√¢ngulo - use raio circular ou pol√≠gono por enquanto.');
}


function saveTeamPosition(teamId, latLng){
  const mapData = Store.get('map_drawings', {});
  if(!mapData.team_positions) mapData.team_positions = {};
  mapData.team_positions[teamId] = {lat: latLng.lat, lng: latLng.lng};
  Store.set('map_drawings', mapData);
}

function panToTeam(teamId){
  const marker = teamMarkers[teamId]?.marker;
  if(marker) {
    mapInstance.panTo(marker.getLatLng());
    marker.openPopup();
  }
}

function addNewTeamToMap(){
  // Modal para adicionar equipe com tipo
  const modal = document.createElement('div');
  modal.id = 'modal_add_team_type';
  modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:10000;';
  
  const content = document.createElement('div');
  content.style.cssText = 'background:#1a1a2e; border:1px solid var(--border); border-radius:12px; padding:24px; width:90%; max-width:500px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.5);';
  
  content.innerHTML = `
    <h3 style="margin-top:0; margin-bottom:20px;">Adicionar em Campo</h3>
    
    <div style="margin-bottom:16px;">
      <label style="display:block; margin-bottom:8px;"><strong>ID/Identificador</strong></label>
      <input id="new_team_id" type="text" placeholder="Ex: GUA-01, AER-02, BOM-03" style="padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--surface); width:100%; box-sizing:border-box;">
    </div>
    
    <div style="margin-bottom:16px;">
      <label style="display:block; margin-bottom:8px;"><strong>Tipo em Campo</strong></label>
      <select id="new_team_type" style="padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--surface); width:100%; box-sizing:border-box;">
        <option value="">Selecione...</option>
        <option value="equipe">üë• Equipe</option>
        <option value="linha_defesa">üõ°Ô∏è Linha de Defesa</option>
        <option value="aceiro">ü™ö Aceiro</option>
        <option value="posto_comando">üì° Posto de Comando</option>
      </select>
    </div>
    
    <div style="margin-bottom:20px;">
      <label style="display:block; margin-bottom:8px;"><strong>Observa√ß√µes</strong></label>
      <textarea id="new_team_notes" placeholder="Ex: Flanco Norte, 5 pessoas, equipado..." rows="3" style="padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--surface); width:100%; box-sizing:border-box;"></textarea>
    </div>
    
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button class="btn btn-secondary" onclick="closeModalAddTeam()">Cancelar</button>
      <button class="btn btn-primary" onclick="confirmAddTeamToMap()">Adicionar</button>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  document.getElementById('new_team_id').focus();
}

function closeModalAddTeam(){
  const modal = document.getElementById('modal_add_team_type');
  if(modal) modal.remove();
}

function confirmAddTeamToMap(){
  const teamId = document.getElementById('new_team_id').value.trim();
  const teamType = document.getElementById('new_team_type').value;
  const teamNotes = document.getElementById('new_team_notes').value.trim();
  
  if(!teamId || !teamType) {
    ARGOS.toast('Preencha ID e Tipo.');
    return;
  }
  
  const tid = teamId.toUpperCase();
  
  // Verificar se j√° existe
  if(teamMarkers[tid]) {
    ARGOS.toast(`Equipe ${tid} j√° posicionada no mapa.`);
    return;
  }
  
  closeModalAddTeam();
  
  // Posi√ß√£o padr√£o pr√≥xima ao PC
  const lat = -15.604 + (Math.random() - 0.5) * 0.005;
  const lng = -56.095 + (Math.random() - 0.5) * 0.005;
  
  // Cores por tipo
  const typeColors = {
    'equipe': '#3B82F6',
    'linha_defesa': '#22c55e',
    'aceiro': '#f59e0b',
    'posto_comando': '#0ea5e9'
  };
  
  const typeIcons = {
    'equipe': 'üë•',
    'linha_defesa': 'üõ°Ô∏è',
    'aceiro': 'ü™ö',
    'posto_comando': 'üì°'
  };
  
  const color = typeColors[teamType] || '#3B82F6';
  const icon = typeIcons[teamType] || '‚óè';
  
  // Criar √≠cone personalizado
  const markerIcon = L.divIcon({
    html: `<div style="background:${color}; width:28px; height:28px; border-radius:50%; border:3px solid #fff; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:14px; box-shadow:0 2px 4px rgba(0,0,0,0.3);">${icon}</div>`,
    className: '',
    iconSize: [34, 34]
  });
  
  const marker = L.marker([lat, lng], {icon: markerIcon, draggable: true}).addTo(mapInstance);
  
  // Criar popup
  const popupContent = `
    <div>
      <b>${tid}</b> <span style="font-size:12px; color:#999;">- ${teamType === 'equipe' ? 'üë• Equipe' : teamType === 'linha_defesa' ? 'üõ°Ô∏è Linha de Defesa' : teamType === 'aceiro' ? 'ü™ö Aceiro' : 'üì° Posto de Comando'}</span><br>
      <small>Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</small>
      ${teamNotes ? `<br><small><em>${teamNotes}</em></small>` : ''}
      <br>
      <button class="btn btn-secondary" style="font-size:11px; margin-top:8px; width:100%; margin-bottom:4px;" onclick="editTeamPosition('${tid}')">üìç Editar Coords</button>
      <button class="btn btn-secondary" style="font-size:11px; width:100%; margin-bottom:4px;" onclick="editTeamNotes('${tid}')">üìù Editar Notas</button>
      <button class="btn btn-danger" style="font-size:11px; width:100%;" onclick="removeTeamFromMap('${tid}')">üóëÔ∏è Remover</button>
    </div>
  `;
  
  marker.bindPopup(popupContent);
  
  marker.on('dragend', () => { 
    const pos = marker.getLatLng();
    saveTeamData(tid, {lat: pos.lat, lng: pos.lng, type: teamType, notes: teamNotes});
    marker.setPopupContent(updateTeamPopupContent(tid, pos.lat, pos.lng, teamType, teamNotes));
  });
  
  teamMarkers[tid] = {marker, color, type: teamType, notes: teamNotes};
  saveTeamData(tid, {lat, lng, type: teamType, notes: teamNotes});
  
  // Atualizar painel de controle
  const teamIds = Object.keys(teamMarkers);
  renderTeamsControlPanel(teamIds);
  renderTeamsList(teamIds);
  
  mapInstance.panTo([lat, lng]);
  ARGOS.toast(`${tid} (${teamType}) adicionada ao mapa.`);
}

function updateTeamPopupContent(teamId, lat, lng, teamType, teamNotes){
  const typeLabels = {
    'equipe': 'üë• Equipe',
    'linha_defesa': 'üõ°Ô∏è Linha de Defesa',
    'aceiro': 'ü™ö Aceiro',
    'posto_comando': 'üì° Posto de Comando'
  };
  
  return `
    <div>
      <b>${teamId}</b> <span style="font-size:12px; color:#999;">- ${typeLabels[teamType] || teamType}</span><br>
      <small>Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</small>
      ${teamNotes ? `<br><small><em>${teamNotes}</em></small>` : ''}
      <br>
      <button class="btn btn-secondary" style="font-size:11px; margin-top:8px; width:100%; margin-bottom:4px;" onclick="editTeamPosition('${teamId}')">üìç Editar Coords</button>
      <button class="btn btn-secondary" style="font-size:11px; width:100%; margin-bottom:4px;" onclick="editTeamNotes('${teamId}')">üìù Editar Notas</button>
      <button class="btn btn-danger" style="font-size:11px; width:100%;" onclick="removeTeamFromMap('${teamId}')">üóëÔ∏è Remover</button>
    </div>
  `;
}

function saveTeamData(teamId, data){
  const mapData = Store.get('map_drawings', {});
  if(!mapData.team_data) mapData.team_data = {};
  mapData.team_data[teamId] = data;
  Store.set('map_drawings', mapData);
}

function editTeamNotes(teamId){
  const marker = teamMarkers[teamId];
  if(!marker) return;
  
  const currentNotes = marker.notes || '';
  const newNotes = prompt('Notas da equipe:', currentNotes);
  if(newNotes === null) return;
  
  marker.notes = newNotes;
  const pos = marker.marker.getLatLng();
  saveTeamData(teamId, {lat: pos.lat, lng: pos.lng, type: marker.type, notes: newNotes});
  marker.marker.setPopupContent(updateTeamPopupContent(teamId, pos.lat, pos.lng, marker.type, newNotes));
  ARGOS.toast('Notas atualizadas.');
}

function removeTeamFromMap(teamId){
  if(confirm(`Remover ${teamId} do mapa?`)) {
    const marker = teamMarkers[teamId]?.marker;
    if(marker) mapInstance.removeLayer(marker);
    delete teamMarkers[teamId];
    
    const mapData = Store.get('map_drawings', {});
    if(mapData.team_data) delete mapData.team_data[teamId];
    Store.set('map_drawings', mapData);
    
    const teamIds = Object.keys(teamMarkers);
    renderTeamsControlPanel(teamIds);
    renderTeamsList(teamIds);
    ARGOS.toast(`${teamId} removida do mapa.`);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initMap();
});
</script>
</section>
    </div>
    <script src="assets/data-plano-acao.js"></script>
    <script src="assets/app.js"></script>
</body>
</html>
